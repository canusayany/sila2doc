# 方法特性标记系统改进说明

## 改进概述

根据用户需求，对方法预览与特性调整功能进行了重大改进，使方法标记系统更加灵活和强大。

## 主要改进

### 1. 方法标记系统从单选变为多选

**之前的设计**：
- 只有一个 `IsMaintenance` 布尔字段
- 方法只能是"维护方法"或"调度方法"之一
- 使用 `MethodCategory` 枚举（只能是 Operations 或 Maintenance）

**改进后的设计**：
- 三个独立的布尔字段：
  - `IsIncluded`：是否包含在D3Driver.cs中（默认 true）
  - `IsOperations`：是否为调度方法（默认 false）
  - `IsMaintenance`：是否为维护方法（默认根据方法名判断）
- 方法可以：
  - 同时是调度方法和维护方法
  - 只是调度方法
  - 只是维护方法
  - 两者都不是
  - 不被包含在D3Driver中

### 2. UI改进

**方法预览窗口（MethodPreviewWindow.xaml）**：

新增三个复选框列：
1. **包含**：控制方法是否被生成到D3Driver.cs中
2. **调度方法**：控制是否添加 `[MethodOperations]` 特性
3. **维护方法**：控制是否添加 `[MethodMaintenance(order)]` 特性

**新增批量操作按钮**：
- **全选/全不选**：切换所有方法的包含状态
- **全部调度**：将所有方法标记为调度方法
- **全部维护**：将所有方法标记为维护方法
- **清除特性**：清除所有方法的调度/维护标记

### 3. 数据模型改进

#### MethodGenerationInfo 类
```csharp
// 新增字段
public bool IsIncluded { get; set; } = true;
public bool IsOperations { get; set; } = false;
public bool IsMaintenance { get; set; } = false;

// 废弃字段（保留用于向后兼容）
[Obsolete("请使用 IsOperations 和 IsMaintenance 替代")]
public MethodCategory Category { get; set; } = MethodCategory.Operations;
```

#### MethodPreviewData 类
```csharp
// 新增字段
private bool _isIncluded = true;
private bool _isOperations = false;

// 保留字段
private bool _isMaintenance = false;
```

### 4. 生成逻辑改进

#### D3DriverGenerator
- **只生成 IsIncluded = true 的方法**
- **支持多特性标记**：
  ```csharp
  // 可以同时添加两个特性
  [MethodOperations]
  [MethodMaintenance(1)]
  public void SomeMethod() { ... }
  
  // 可以只添加一个
  [MethodOperations]
  public void AnotherMethod() { ... }
  
  // 可以不添加任何特性
  public void YetAnotherMethod() { ... }
  ```

### 5. 同步逻辑改进

```csharp
// 同步方法标记信息
method.IsIncluded = previewData.IsIncluded;
method.IsOperations = previewData.IsOperations;
method.IsMaintenance = previewData.IsMaintenance;
```

## 使用示例

### 场景1：只生成部分方法
1. 打开方法预览窗口
2. 取消不需要的方法的"包含"复选框
3. 确认后，这些方法不会出现在D3Driver.cs中

### 场景2：方法既是调度方法又是维护方法
1. 打开方法预览窗口
2. 同时勾选某个方法的"调度方法"和"维护方法"
3. 确认后，该方法会有两个特性：
   ```csharp
   [MethodOperations]
   [MethodMaintenance(1)]
   public void MyMethod() { ... }
   ```

### 场景3：方法没有任何特性
1. 打开方法预览窗口
2. 保持"调度方法"和"维护方法"都不勾选
3. 确认后，该方法不会有特性标记：
   ```csharp
   public void MyMethod() { ... }
   ```

### 场景4：批量设置
- 点击"全部调度"按钮，所有方法都会被标记为调度方法
- 点击"全部维护"按钮，所有方法都会被标记为维护方法
- 点击"清除特性"按钮，清除所有调度/维护标记
- 点击"全选/全不选"按钮，切换所有方法的包含状态

## 默认行为

### 方法分析时的默认值
```csharp
IsIncluded = true;  // 默认包含所有方法
IsOperations = false;  // 默认不是调度方法
IsMaintenance = DetermineIfMaintenance(method);  // 根据方法名判断
```

### 判断是否为维护方法的规则
方法名包含以下关键词时，默认标记为维护方法：
- "maintenance"
- "calibrate"
- "reset"
- "init"
- "config"

## 测试验证

所有自动化测试都通过：
```
✓ 测试1：生成D3项目 - 通过
✓ 测试2：编译项目 - 通过
✓ 测试3：调整方法分类 - 通过
✓ 测试4：无效文件处理 - 通过
✓ 测试5：编译失败处理 - 通过
✓ 测试6：多特性完整流程 - 通过
```

## 兼容性

- ✅ 向后兼容：旧的 `Category` 字段仍然存在（标记为废弃）
- ✅ 自动迁移：同步逻辑会自动将新字段映射到旧字段
- ✅ 无破坏性更改：所有现有功能继续工作

## 相关文件

### 修改的文件
1. `Models/MethodGenerationInfo.cs` - 添加新字段
2. `Models/ClientAnalysisResult.cs` - MethodPreviewData 添加新字段
3. `Views/MethodPreviewWindow.xaml` - UI 添加三个复选框列
4. `ViewModels/MethodPreviewViewModel.cs` - 添加批量操作命令
5. `Services/CodeDom/D3DriverGenerator.cs` - 支持多特性标记
6. `ViewModels/D3DriverViewModel.cs` - 更新同步逻辑
7. `Services/ClientCodeAnalyzer.cs` - 使用新字段
8. `Services/D3DriverGeneratorService.cs` - 使用新字段
9. `Services/D3DriverOrchestrationService.cs` - 使用新字段

### 受影响的功能
- 方法预览与特性调整
- D3Driver.cs 生成
- 方法分类调整
- 自动化测试

## 总结

此次改进使方法特性标记系统更加灵活和强大，满足了以下需求：
1. ✅ 方法可以同时被标记为调度方法和维护方法
2. ✅ 方法可以两者都不是
3. ✅ 可以选择性地包含/排除方法
4. ✅ 提供批量操作功能提高效率
5. ✅ 保持向后兼容性

---

**版本**: 2.0  
**日期**: 2024-10-24  
**作者**: AI Assistant

