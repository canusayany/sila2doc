<UserControl
    x:Class="SilaGeneratorWpf.Views.D3DriverView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:SilaGeneratorWpf.Models"
    xmlns:converters="clr-namespace:SilaGeneratorWpf.Converters"
    xmlns:behaviors="clr-namespace:SilaGeneratorWpf.Behaviors"
    xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
    d:DesignHeight="700"
    d:DesignWidth="1200"
    mc:Ignorable="d">
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter" />
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
    </UserControl.Resources>
    <Grid>
        <Grid.ColumnDefinitions>
            <!--  左侧栏（可折叠）  -->
            <ColumnDefinition Width="{Binding SidebarWidthValue}" MinWidth="0" MaxWidth="450" />
            <!--  GridSplitter  -->
            <ColumnDefinition Width="5" />
            <!--  主区域  -->
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!--  左侧栏：特性选择  -->
        <Border
            Grid.Column="0"
            Background="#F8F9FA"
            BorderBrush="#DEE2E6"
            BorderThickness="0,0,1,0"
            Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisibilityConverter}}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <!--  标题栏  -->
                    <RowDefinition Height="Auto" />
                    <!--  工具栏  -->
                    <RowDefinition Height="250" />
                    <!--  在线服务器树（固定高度）  -->
                    <RowDefinition Height="*" />
                    <!--  本地特性树（条件显示）  -->
                </Grid.RowDefinitions>

                <!--  标题栏（VS2022风格，带折叠按钮）  -->
                <Border 
                    Grid.Row="0" 
                    Background="#E8EAED" 
                    BorderBrush="#DEE2E6" 
                    BorderThickness="0,0,0,1"
                    Padding="10,5">
                    <Grid>
                        <TextBlock
                            Text="特性选择"
                            FontSize="14"
                            FontWeight="SemiBold"
                            VerticalAlignment="Center"
                            Foreground="#2C3E50" />
                        
                        <!--  图钉按钮（右侧）  -->
                        <Button
                            HorizontalAlignment="Right"
                            Width="20"
                            Height="20"
                            Background="Transparent"
                            BorderThickness="0"
                            Command="{Binding ToggleSidebarCommand}"
                            ToolTip="隐藏侧边栏 (双击分隔线也可切换)"
                            Cursor="Hand">
                            <TextBlock 
                                Text="📌" 
                                FontSize="12" 
                                VerticalAlignment="Center"
                                HorizontalAlignment="Center">
                                <TextBlock.RenderTransform>
                                    <RotateTransform Angle="-45" CenterX="6" CenterY="6"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="Transparent" />
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#D0D3D6" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Grid>
                </Border>

                <!--  工具栏  -->
                <StackPanel
                    Grid.Row="1"
                    Margin="10"
                    Orientation="Vertical">

                    <!--  实时监控状态显示  -->
                    <Border 
                        Background="#E8F5E9"
                        BorderBrush="#4CAF50"
                        BorderThickness="1"
                        CornerRadius="3"
                        Padding="8,5"
                        Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock 
                                Text="🟢" 
                                FontSize="12" 
                                VerticalAlignment="Center"
                                Margin="0,0,5,0"/>
                            <TextBlock 
                                Text="实时监控已启动" 
                                FontSize="11"
                                FontWeight="Medium"
                                Foreground="#2E7D32"
                                VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>

                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                        <Button
                            Margin="0,0,5,0"
                            Padding="10,8"
                            Background="#8764B8"
                            BorderThickness="0"
                            Command="{Binding AddLocalFeaturesCommand}"
                            Content="📁 添加"
                            Foreground="White"
                            FontWeight="Medium"
                            ToolTip="导入本地.sila.xml特性文件">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#8764B8"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#744DA9"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        
                        <Button
                            Padding="10,8"
                            Background="#107C10"
                            BorderThickness="0"
                            Command="{Binding ExportFeaturesCommand}"
                            Content="📤 导出"
                            Foreground="White"
                            FontWeight="Medium"
                            ToolTip="导出选中的特性文件到指定文件夹">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="#107C10"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#0E6A0E"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                </StackPanel>

                <!--  在线服务器树（固定高度250px）  -->
                <GroupBox
                    Grid.Row="2"
                    Header="在线服务器"
                    Margin="10,0,10,10">
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Height="210">
                        <TreeView ItemsSource="{Binding OnlineServers}">
                        <TreeView.Resources>
                            <!--  服务器节点模板（三态CheckBox）  -->
                            <HierarchicalDataTemplate DataType="{x:Type local:ServerInfoViewModel}" ItemsSource="{Binding Features}">
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox
                                        Margin="0,0,5,0"
                                        IsThreeState="True"
                                        IsChecked="{Binding IsPartiallySelected}">
                                        <i:Interaction.Behaviors>
                                            <behaviors:ThreeStateTreeViewBehavior />
                                        </i:Interaction.Behaviors>
                                    </CheckBox>
                                    <TextBlock Margin="0,0,5,0" Text="🖥️" />
                                    <TextBlock Text="{Binding DisplayText}" />
                                </StackPanel>
                            </HierarchicalDataTemplate>
                            <!--  特性节点模板  -->
                            <DataTemplate DataType="{x:Type local:FeatureInfoViewModel}">
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox Margin="0,0,5,0" IsChecked="{Binding IsSelected}" />
                                    <TextBlock Margin="0,0,5,0" Text="📦" />
                                    <TextBlock Text="{Binding DisplayText}" />
                                </StackPanel>
                            </DataTemplate>
                        </TreeView.Resources>
                        </TreeView>
                    </ScrollViewer>
                </GroupBox>

                <!--  本地特性树（条件显示）  -->
                <GroupBox
                    Grid.Row="3"
                    Header="本地特性"
                    Margin="10,0,10,10"
                    Visibility="{Binding LocalNodes.Count, Converter={StaticResource CountToVisibilityConverter}}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <TreeView ItemsSource="{Binding LocalNodes}" x:Name="LocalFeaturesTreeView" Tag="{Binding}">
                        <TreeView.Resources>
                            <!--  本地节点模板  -->
                            <HierarchicalDataTemplate DataType="{x:Type local:LocalFeatureNodeViewModel}" ItemsSource="{Binding Files}">
                                <StackPanel Orientation="Horizontal" Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TreeView}}">
                                    <CheckBox
                                        Margin="0,0,5,0"
                                        IsThreeState="True"
                                        IsChecked="{Binding IsPartiallySelected}"
                                        ToolTip="点击切换：未选→全选→未选，半选→未选">
                                        <i:Interaction.Behaviors>
                                            <behaviors:ThreeStateTreeViewBehavior />
                                        </i:Interaction.Behaviors>
                                    </CheckBox>
                                    <TextBlock Margin="0,0,5,0" Text="📂" />
                                    <TextBlock Text="{Binding DisplayText}" ToolTip="{Binding NodePath}" />
                                    <StackPanel.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="删除节点" 
                                                      Command="{Binding PlacementTarget.Tag.DeleteLocalNodeCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                      CommandParameter="{Binding}" />
                                        </ContextMenu>
                                    </StackPanel.ContextMenu>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                            <!--  本地特性文件模板  -->
                            <HierarchicalDataTemplate DataType="{x:Type local:LocalFeatureFileViewModel}">
                                <StackPanel Orientation="Horizontal" Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TreeView}}">
                                    <CheckBox Margin="0,0,5,0" IsChecked="{Binding IsSelected}" />
                                    <TextBlock Margin="0,0,5,0" Text="📄" />
                                    <TextBlock Text="{Binding FileName}" />
                                    <StackPanel.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="删除文件" 
                                                      Command="{Binding PlacementTarget.Tag.DeleteLocalFileCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}" 
                                                      CommandParameter="{Binding}" />
                                        </ContextMenu>
                                    </StackPanel.ContextMenu>
                                </StackPanel>
                            </HierarchicalDataTemplate>
                        </TreeView.Resources>
                        </TreeView>
                    </ScrollViewer>
                </GroupBox>
            </Grid>
        </Border>

        <!--  GridSplitter（可拖动调整宽度，双击切换侧边栏）  -->
        <GridSplitter
            Grid.Column="1"
            Width="5"
            HorizontalAlignment="Stretch"
            Background="#DEE2E6"
            MouseDoubleClick="GridSplitter_MouseDoubleClick"
            Cursor="SizeWE"
            ToolTip="拖动调整宽度，双击隐藏侧边栏"
            Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisibilityConverter}}" />
        
        <!--  侧边栏隐藏时的显示按钮（竖向文字）  -->
        <Button
            Grid.Column="0"
            Grid.ColumnSpan="2"
            Width="30"
            Height="120"
            
            HorizontalAlignment="Left"
            VerticalAlignment="Center"
            Background="#F8F9FA"
            BorderThickness="1"
            BorderBrush="#DEE2E6"
            Command="{Binding ToggleSidebarCommand}"
            Cursor="Hand"
            ToolTip="显示侧边栏"
            Visibility="{Binding IsSidebarVisible, Converter={StaticResource InverseBoolToVisibilityConverter}}">
            <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                <TextBlock 
                    Text="📌" 
                    FontSize="14"
                    Margin="0,5,0,5"
                    HorizontalAlignment="Center">
                    <TextBlock.RenderTransform>
                        <RotateTransform Angle="45" CenterX="7" CenterY="7"/>
                    </TextBlock.RenderTransform>
                </TextBlock>
                <TextBlock 
                    Text="特" 
                    FontSize="12" 
                    FontWeight="SemiBold"
                    Foreground="#2C3E50"
                    HorizontalAlignment="Center"
                    Margin="0,2"/>
                <TextBlock 
                    Text="性" 
                    FontSize="12" 
                    FontWeight="SemiBold"
                    Foreground="#2C3E50"
                    HorizontalAlignment="Center"
                    Margin="0,2"/>
                <TextBlock 
                    Text="选" 
                    FontSize="12" 
                    FontWeight="SemiBold"
                    Foreground="#2C3E50"
                    HorizontalAlignment="Center"
                    Margin="0,2"/>
                <TextBlock 
                    Text="择" 
                    FontSize="12" 
                    FontWeight="SemiBold"
                    Foreground="#2C3E50"
                    HorizontalAlignment="Center"
                    Margin="0,2"/>
            </StackPanel>
            <Button.Style>
                <Style TargetType="Button">
                    <Setter Property="Background" Value="#F8F9FA" />
                    <Style.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="#E8EAED" />
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Button.Style>
        </Button>

        <!--  主区域（移除方法预览和设备信息输入）  -->
        <Grid Grid.Column="2" Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <!--  过程日志  -->
                <RowDefinition Height="*" />
                <!--  项目信息  -->
                <RowDefinition Height="Auto" />
                <!--  操作按钮  -->
            </Grid.RowDefinitions>

            <!--  过程信息显示区域  -->
            <Expander
                Grid.Row="0"
                Header="生成过程信息"
                IsExpanded="True"
                Margin="0,0,0,10">
                <TextBox
                    Height="200"
                    FontFamily="Consolas"
                    IsReadOnly="True"
                    Text="{Binding ProcessLog, Mode=OneWay}"
                    TextWrapping="Wrap"
                    Foreground="{Binding ProcessLogColor}"
                    VerticalScrollBarVisibility="Auto" />
            </Expander>

            <!--  项目信息显示区域  -->
            <GroupBox
                Grid.Row="1"
                Header="项目信息"
                Margin="0,0,0,10">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <TextBlock
                        Text="{Binding ProjectInfoText}"
                        TextWrapping="Wrap"
                        Padding="10"
                        FontFamily="Consolas" />
                </ScrollViewer>
            </GroupBox>

            <!--  操作按钮（5个）  -->
            <WrapPanel
                Grid.Row="2"
                HorizontalAlignment="Right"
                Orientation="Horizontal">
                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#107C10"
                    BorderThickness="0"
                    Command="{Binding OpenProjectDirectoryCommand}"
                    Content="🗂️ 项目目录"
                    Foreground="White"
                    FontWeight="Medium"
                    ToolTip="打开生成的项目目录">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#107C10"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#0E6A0E"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#8764B8"
                    BorderThickness="0"
                    Command="{Binding OpenDllDirectoryCommand}"
                    Content="📦 DLL目录"
                    Foreground="White"
                    FontWeight="Medium"
                    ToolTip="打开编译输出的DLL目录">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#8764B8"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#744DA9"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#0078D4"
                    BorderThickness="0"
                    Command="{Binding GenerateD3ProjectCommand}"
                    Content="✨ 生成项目"
                    Foreground="White"
                    FontWeight="Bold"
                    ToolTip="生成客户端代码和D3驱动代码（不编译）">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#0078D4"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#106EBE"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#0078D4"
                    BorderThickness="0"
                    Command="{Binding CompileD3ProjectCommand}"
                    Content="🔨 编译项目"
                    Foreground="White"
                    FontWeight="Bold"
                    IsEnabled="{Binding CanCompile}"
                    ToolTip="编译已生成的项目（需要先生成）">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#0078D4"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#106EBE"/>
                                </Trigger>
                                <Trigger Property="IsEnabled" Value="False">
                                    <Setter Property="Background" Value="#CCCCCC"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#CA5010"
                    BorderThickness="0"
                    Command="{Binding AdjustMethodAttributesCommand}"
                    Content="🔧 调整特性"
                    Foreground="White"
                    FontWeight="Medium"
                    Visibility="{Binding CanAdjustMethods, Converter={StaticResource BoolToVisibilityConverter}}"
                    ToolTip="打开方法预览与特性调整窗口">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#CA5010"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#A74109"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#00796B"
                    BorderThickness="0"
                    Command="{Binding PackageDriverCommand}"
                    Content="📦 打包驱动"
                    Foreground="White"
                    FontWeight="Bold"
                    Visibility="{Binding CanPackage, Converter={StaticResource BoolToVisibilityConverter}}"
                    ToolTip="生成描述文件并打包驱动">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#00796B"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#00695C"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <Button
                    Margin="5"
                    Padding="12,8"
                    Background="#5C6BC0"
                    BorderThickness="0"
                    Command="{Binding TestPackageDriverCommand}"
                    Content="🧪 测试打包"
                    Foreground="White"
                    FontWeight="Medium"
                    Visibility="Collapsed"
                    ToolTip="使用固定路径测试生成描述文件与打包流程">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#5C6BC0"/>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#3F51B5"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>
            </WrapPanel>
        </Grid>
    </Grid>
</UserControl>
