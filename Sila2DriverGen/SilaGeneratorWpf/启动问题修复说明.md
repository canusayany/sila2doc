# SilaGeneratorWpf 启动问题修复说明

## 问题描述

应用程序启动时出现 `System.Windows.Markup.XamlParseException` 错误：

```
内部异常 1: TypeInitializationException: The type initializer for 'BR.PC.Device.Sila2Discovery.Sila2Discovery' threw an exception.
内部异常 2: IOException: 句柄无效。
```

## 问题原因

`BR.PC.Device.Sila2Discovery.Sila2Discovery` 类的静态构造函数中尝试设置 `Console.OutputEncoding`，但 WPF 应用程序默认没有控制台窗口，导致"句柄无效"错误。

调用堆栈：
```
System.ConsolePal.SetConsoleOutputEncoding(System.Text.Encoding)
System.Console.OutputEncoding.set(System.Text.Encoding)
BR.PC.Device.Sila2Discovery.Sila2Discovery.Sila2Discovery()
```

## 解决方案

在 `App.xaml.cs` 中添加了控制台分配和隐藏功能：

### 1. 添加 Windows API 声明

```csharp
[DllImport("kernel32.dll", SetLastError = true)]
[return: MarshalAs(UnmanagedType.Bool)]
private static extern bool AllocConsole();

[DllImport("kernel32.dll", SetLastError = true)]
[return: MarshalAs(UnmanagedType.Bool)]
private static extern bool FreeConsole();

[DllImport("kernel32.dll")]
private static extern IntPtr GetConsoleWindow();

[DllImport("user32.dll")]
private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);

private const int SW_HIDE = 0;
```

### 2. 在构造函数中分配并隐藏控制台

```csharp
public App()
{
    // 为 Sila2Discovery 分配控制台（它需要设置Console.OutputEncoding）
    AllocConsole();
    
    // 隐藏控制台窗口（但保持句柄有效）
    var consoleWindow = GetConsoleWindow();
    if (consoleWindow != IntPtr.Zero)
    {
        ShowWindow(consoleWindow, SW_HIDE);
    }
    
    // 捕获所有未处理的异常
    AppDomain.CurrentDomain.UnhandledException += CurrentDomain_UnhandledException;
    DispatcherUnhandledException += App_DispatcherUnhandledException;
}
```

### 3. 在退出时释放控制台

```csharp
protected override void OnExit(ExitEventArgs e)
{
    var logger = LoggerService.GetLogger<App>();
    logger.LogInformation("应用程序退出");
    
    LoggerService.Shutdown();
    
    if (_serviceProvider is IDisposable disposable)
    {
        disposable.Dispose();
    }
    
    // 释放控制台
    FreeConsole();
    
    base.OnExit(e);
}
```

## 修复结果

✅ **应用程序启动成功**  
✅ **控制台窗口已隐藏**（用户不可见）  
✅ **Sila2Discovery 可以正常使用控制台句柄**  
✅ **实时监控功能正常启动**  

## 技术细节

- **AllocConsole()**: 为进程分配一个新的控制台窗口
- **ShowWindow(hWnd, SW_HIDE)**: 隐藏控制台窗口，但保持句柄有效
- **FreeConsole()**: 在应用退出时释放控制台资源

这种方法确保了 `BR.PC.Device.Sila2Discovery` 库可以正常设置控制台编码，同时不影响 WPF 应用的用户体验。

## 相关文件

- `SilaGeneratorWpf/App.xaml.cs` - 主要修改文件
- `SilaGeneratorWpf/Services/Sila2RealTimeDiscoveryService.cs` - 使用 Sila2Discovery 的服务
- `SilaGeneratorWpf/ViewModels/D3DriverViewModel.cs` - 初始化实时监控的 ViewModel
- `SilaGeneratorWpf/ViewModels/ServerDiscoveryViewModel.cs` - 初始化实时监控的 ViewModel

## 测试验证

日期: 2025-01-XX  
状态: ✅ 通过  
测试方法: 启动应用程序 3 秒，无错误退出  

