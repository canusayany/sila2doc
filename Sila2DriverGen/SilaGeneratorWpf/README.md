# SiLA2 驱动生成器 WPF 应用

## 📋 概述

SiLA2 驱动生成器是一个功能强大的 WPF 应用程序,用于从 SiLA2 服务器或本地特性文件自动生成符合 D3 系统规范的设备驱动代码。

**版本**: v1.2 (实时监控版)  
**最后更新**: 2025-01-28

## 🔧 重要说明

### 控制台窗口处理
应用程序会在启动时自动分配一个隐藏的控制台窗口,这是为了支持 `BR.PC.Device.Sila2Discovery` 库的正常运行。该库需要访问控制台句柄来设置输出编码。**控制台窗口对用户不可见**,不会影响使用体验。

详细技术说明请参考: [启动问题修复说明.md](启动问题修复说明.md)

### ServerData 缓存机制
应用程序采用 ViewModel 级别的 ServerData 缓存机制，确保实时监控和手动扫描的服务器数据统一管理。每个 `ServerInfoViewModel` 都包含 `ServerDataCache` 属性，用于存储服务器的完整特性数据。

详细技术说明请参考: [ServerData缓存修复说明.md](ServerData缓存修复说明.md)

## ✨ 主要功能

- 🟢 **实时服务器监控** - 自动监控网络中的 SiLA2 服务器上线/下线状态（基于 Sila2Discovery）
- 📁 **本地特性支持** - 导入和管理本地 .sila.xml 特性文件（支持显示磁盘路径）
- ✨ **自动代码生成** - 生成完整的 D3 驱动项目(包含客户端代码和驱动封装)
- 🔨 **一键编译** - 自动编译生成的项目并输出 DLL（不使用NuGet,直接引用reflib中的DLL）
- 🔧 **方法分类调整** - 灵活配置方法的"调度"和"维护"特性
- 📤 **特性导出** - 导出选中的特性文件到指定位置

## 🚀 快速开始

### 启动应用

1. 双击运行 `SilaGeneratorWpf.exe`
2. 或使用命令行: `dotnet run --project SilaGeneratorWpf`

### 使用流程

#### 方式 1: 从在线服务器生成

1. **实时监控自动启动** - 应用启动后会自动监控网络中的 SiLA2 服务器
2. 等待服务器出现在左侧树形列表中（显示绿色"实时监控已启动"状态）
3. 在左侧树形列表中勾选需要的特性
4. 点击 **✨ 生成项目** 按钮
5. 输入设备信息(品牌、型号、类型、开发者)
6. 在方法预览窗口中配置方法特性
7. 等待生成完成
8. 点击 **🔨 编译项目** 进行编译

#### 方式 2: 从本地文件生成

1. 点击 **📁 添加** 按钮导入本地 .sila.xml 文件
2. 在左侧树形列表中勾选需要的特性（可查看文件的磁盘路径）
3. 后续步骤同方式1的第4-8步

**提示**: 可右键点击节点或文件从列表中删除（不会删除磁盘文件）

## 🎨 界面说明

### 左侧栏 - 特性选择

- **在线服务器区域** - 显示扫描到的服务器及其特性(三态勾选)
- **本地特性区域** - 显示导入的本地特性文件(支持右键删除,不删除磁盘文件)
- **工具按钮**:
  - 🔍 扫描 - 扫描网络服务器
  - 📁 添加 - 添加本地特性文件  
  - 📤 导出 - 导出选中的特性

### 主区域

- **生成过程信息** - 实时显示代码生成和编译过程
- **项目信息** - 显示生成的项目路径和状态
- **操作按钮**:
  - 🗂️ 项目目录 - 打开生成的项目文件夹
  - 📦 DLL目录 - 打开编译输出的DLL文件夹
  - ✨ 生成项目 - 开始生成D3驱动项目
  - 🔨 编译项目 - 编译已生成的项目
  - 🔧 调整特性 - 重新配置方法特性

## 📝 日志系统

应用程序会自动记录运行日志到 `Logs` 目录:

- 日志文件格式: `SilaGenerator_yyyyMMdd.log`
- 自动按日滚动
- 保留最近30天的日志
- 单个日志文件最大1GB

### 日志级别

- **Debug模式**: 记录详细的调试信息
- **Release模式**: 只记录关键信息和错误

## 🔧 系统要求

- **.NET 8.0** SDK 或更高版本
- **Windows 10/11** 操作系统
- **4GB RAM** 推荐
- **网络连接** (用于在线服务器扫描和NuGet包还原)

## 📚 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| .NET | 8.0 | 应用框架 |
| WPF | - | UI框架 |
| CommunityToolkit.Mvvm | Latest | MVVM框架 |
| Serilog | Latest | 日志系统 |
| Tecan.Sila2 | 4.4.1 | SiLA2客户端库 |
| Newtonsoft.Json | 13.0.3 | JSON序列化 |

## 🎯 设计特点

### Fluent Design 配色

- 主操作按钮: `#0078D4` (Azure Blue)
- 成功/打开操作: `#107C10` (Green)
- 文件/DLL操作: `#8764B8` (Purple)
- 调整/配置操作: `#CA5010` (Orange)

### MVVM 架构

- **Models** - 数据模型和业务实体
- **ViewModels** - 视图逻辑和命令处理
- **Views** - UI界面和用户交互
- **Services** - 业务服务和工具类

## 🐛 故障排除

### 常见问题

**Q: 扫描不到在线服务器?**

A: 检查以下事项:
- SiLA2服务器是否正在运行
- 是否在同一网络内
- 防火墙是否允许mDNS(端口5353)

**Q: 编译失败?**

A: 可能的原因:
- 缺少.NET SDK
- 网络问题导致NuGet包还原失败
- 依赖库版本不兼容

**Q: 生成的代码有警告?**

A: 少量nullable警告是正常的,不影响功能。可以在生成的项目中配置 `<Nullable>disable</Nullable>` 来关闭nullable检查。

## 📖 相关文档

- [项目文档](../plan.md) - 完整的项目文档和技术说明
- [测试指南](../TestConsole/README.md) - 测试控制台使用说明
- [更新日志](../plan.md#更新日志) - 版本历史和改进记录

## 🤝 贡献

如有问题或建议,请联系 Bioyond Team。

---

**开发团队**: Bioyond Team  
**最后更新**: 2024-10-28
