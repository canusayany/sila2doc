# TestConsole 测试运行指南

## 快速开始

### 方式1：交互式测试（推荐新手）

```powershell
cd Sila2DriverGen/TestConsole
dotnet run
```

按照菜单提示选择测试场景：
1. **测试1**：从本地XML生成D3项目
2. **测试2**：编译已生成的D3项目
3. **测试3**：完整流程（生成+编译）
4. **测试4**：调整方法分类并重新生成
5. **测试5**：错误处理测试（无效文件）
6. **测试6**：错误处理测试（编译失败）
7. **测试7**：查看测试说明

### 方式2：自动化测试（推荐验证）

```powershell
cd Sila2DriverGen/TestConsole
dotnet run -- --auto
```

自动运行所有测试并报告结果。

## 测试准备

### 必需条件

1. **安装 .NET 8.0 SDK**
   ```powershell
   dotnet --version  # 应显示 8.x.x
   ```

2. **准备测试文件**
   - 测试会自动查找 `TemperatureController-v1_0.sila.xml`
   - 已在以下位置找到该文件：
     - `doc/TemperatureController-v1_0.sila.xml`
     - `doc/Sila2DriverGen/SilaGeneratorWpf/TemperatureController-v1_0.sila.xml`

3. **网络连接**
   - 用于NuGet包还原（首次编译时需要）

## 测试场景说明

### 1. 从本地XML生成D3项目

**测试内容**：
- 读取本地 `.sila.xml` 特性文件
- 生成客户端代码（使用Tecan Generator）
- 分析客户端代码结构
- 生成D3驱动代码（AllSila2Client.cs, D3Driver.cs等）
- 创建项目文件和解决方案

**验证点**：
- ✓ 项目目录已创建
- ✓ 客户端代码已生成（GeneratedClient/目录）
- ✓ D3驱动文件已生成
- ✓ 项目文件已生成（.csproj, .sln）

**输出位置**：
- `%TEMP%\Sila2D3Gen\{Brand}_{Model}_{timestamp}\`

### 2. 编译已生成的D3项目

**测试内容**：
- 使用 `dotnet build` 编译项目
- 解析编译输出（错误、警告）
- 验证DLL生成

**验证点**：
- ✓ 编译成功，无错误
- ✓ DLL文件已生成在 bin/Release 目录
- ✓ 编译警告数量合理

### 3. 完整流程（生成+编译）

**测试内容**：
- 依次执行测试1和测试2
- 验证端到端流程

**验证点**：
- ✓ 生成和编译均成功
- ✓ 可生成可用的D3驱动DLL

### 4. 调整方法分类并重新生成

**测试内容**：
- 重新分析已生成项目的客户端代码
- 应用方法分类配置（Operations vs Maintenance）
- 重新生成 D3Driver.cs 文件

**验证点**：
- ✓ 方法分类已应用
- ✓ D3Driver.cs文件已更新
- ✓ 可以重新编译项目

**方法分类说明**：
- **Operations方法**：生成 `[MethodOperations]` 特性
- **Maintenance方法**：生成 `[MethodMaintenance]` 特性

### 5. 错误处理测试（无效文件）

**测试内容**：
- 使用不存在的XML文件路径
- 验证错误捕获和报告

**验证点**：
- ✓ 成功捕获错误
- ✓ 返回清晰的错误信息
- ✓ 程序不会崩溃

### 6. 错误处理测试（编译失败）

**测试内容**：
- 尝试编译不存在的项目
- 验证编译错误处理

**验证点**：
- ✓ 成功捕获编译错误
- ✓ 返回清晰的错误信息
- ✓ 程序不会崩溃

## 生成的文件结构

```
%TEMP%\Sila2D3Gen\{Brand}_{Model}_{timestamp}\
│
├── GeneratedClient/              # Tecan Generator生成的客户端代码
│   ├── I{FeatureName}.cs        # 特性接口
│   ├── {FeatureName}Client.cs   # 特性客户端实现
│   └── DTOs/                    # 数据传输对象
│       └── *.cs
│
├── Sila2Client/                  # 复制的客户端代码
│   └── *.cs
│
├── lib/                          # 依赖库
│   ├── BR.ECS.Executor.Device.Domain.Contracts.dll
│   ├── BR.ECS.Executor.Device.Domain.Share.dll
│   ├── BR.ECS.Executor.Device.Infrastructure.dll
│   └── BR.PC.Device.Sila2Discovery.dll
│
├── AllSila2Client.cs             # 所有客户端的聚合类
├── D3Driver.cs                   # D3驱动主类（包含所有方法）
├── Sila2Base.cs                  # Sila2基类（连接管理）
├── CommunicationPars.cs          # 通信参数类
│
├── {Brand}{Model}.D3Driver.csproj   # 项目文件
├── {Brand}{Model}.D3Driver.sln      # 解决方案文件
│
└── bin/Release/                  # 编译输出（编译后）
    └── net8.0/
        └── *.dll
```

## 接口可测试性验证

### 重构的服务接口

#### D3DriverOrchestrationService（新增方法）

```csharp
// 方法分类调整接口（新增）
public async Task<OrchestrationResult> AdjustMethodClassificationsAsync(
    string projectPath,
    Dictionary<string, bool> methodClassifications,
    Action<string>? progressCallback = null)
```

**功能**：
- 从已生成的项目重新分析客户端代码
- 应用方法分类配置
- 重新生成D3Driver.cs文件

**可测试性**：
- ✓ 无UI依赖
- ✓ 接受项目路径和配置字典
- ✓ 返回结果对象
- ✓ 支持进度回调

### 现有接口验证

#### GenerateD3ProjectAsync

```csharp
public async Task<OrchestrationResult> GenerateD3ProjectAsync(
    D3GenerationRequest request,
    Action<string>? progressCallback = null)
```

**可测试性**：
- ✓ 无UI依赖
- ✓ 接受配置对象
- ✓ 返回结果对象
- ✓ 支持进度回调

#### CompileD3ProjectAsync

```csharp
public async Task<CompilationResult> CompileD3ProjectAsync(
    string projectPath,
    Action<string>? progressCallback = null)
```

**可测试性**：
- ✓ 无UI依赖
- ✓ 接受项目路径
- ✓ 返回编译结果对象
- ✓ 支持进度回调

## 测试覆盖范围

### 功能覆盖

- ✅ 客户端代码生成（从本地XML）
- ✅ 代码分析
- ✅ D3驱动代码生成
- ✅ 项目文件生成
- ✅ 项目编译
- ✅ 方法分类调整
- ✅ 错误处理

### 边界条件测试

- ✅ 无效文件路径
- ✅ 不存在的项目
- ✅ 编译失败场景

### 未覆盖场景（需要在WPF应用中手动测试）

- ❌ 在线服务器扫描（需要实际SiLA2服务器）
- ❌ 从在线服务器生成（需要Feature对象）
- ❌ UI交互（三态CheckBox、对话框等）

## 验证清单

### 核心功能验证

- [ ] 从本地XML生成D3项目成功
- [ ] 客户端代码生成正确
- [ ] 代码分析功能正常
- [ ] D3驱动代码生成正确
- [ ] 项目文件生成正确
- [ ] 项目编译成功
- [ ] DLL文件生成正确
- [ ] 方法分类调整功能正常
- [ ] 重新生成D3Driver.cs成功

### 错误处理验证

- [ ] 无效文件错误捕获正确
- [ ] 编译失败错误捕获正确
- [ ] 错误信息清晰明确
- [ ] 程序不会因错误崩溃

### 接口可测试性验证

- [ ] D3DriverOrchestrationService 无UI依赖
- [ ] 所有公共方法可测试
- [ ] 进度回调功能正常
- [ ] 异步操作正常

## 故障排查

### 问题1：找不到XML文件

**症状**：测试报告"未找到示例XML文件"

**解决**：
1. 检查文件是否存在：`dir TemperatureController-v1_0.sila.xml /s`
2. 手动复制到TestConsole目录：
   ```powershell
   copy ..\SilaGeneratorWpf\TemperatureController-v1_0.sila.xml .
   ```

### 问题2：编译失败（缺少依赖库）

**症状**：编译报错找不到BR.ECS.*引用

**解决**：
1. 确保 `BR.ECS.DeviceDriver.Sample.Test/lib/` 目录存在
2. 手动复制依赖库到生成项目的lib目录

### 问题3：NuGet包还原失败

**症状**：编译报错找不到Tecan.Sila2.*包

**解决**：
```powershell
dotnet restore
```

## 相关文档

- [README.md](README.md) - 项目概述和快速开始
- [SilaGeneratorWpf/README.md](../SilaGeneratorWpf/README.md) - WPF应用文档
- [plan.md](../../plan.md) - 项目计划

## 联系方式

如有问题，请参考项目文档或联系开发团队。

---

**最后更新**: 2024-10-23  
**测试框架版本**: 1.0.0

