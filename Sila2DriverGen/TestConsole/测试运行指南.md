# SiLA2 D3驱动生成工具 - 测试运行指南

## 📋 文档目的

本指南详细说明如何运行和验证 D3驱动生成工具的各项测试，确保工具功能正常工作。

## 🎯 测试目标

验证以下核心功能：

1. **客户端代码生成**：从SiLA2特性文件生成C#客户端代码
2. **代码分析**：分析生成的客户端代码，提取方法和类型信息
3. **D3驱动代码生成**：基于分析结果生成D3系统兼容的驱动代码
4. **项目编译**：验证生成的项目可以成功编译
5. **方法分类**：支持动态调整方法分类（操作/维护）
6. **错误处理**：正确处理各种异常情况
7. **在线服务器支持**：支持从在线SiLA2服务器生成驱动

## 🚀 快速开始

### 前置条件

```powershell
# 确认开发环境
dotnet --version  # 应该是 8.0.x

# 进入测试目录
cd Sila2DriverGen/TestConsole

# 确认XML测试文件存在
Get-Item "../../TemperatureController-v1_0.sila.xml"
```

### 运行所有测试（推荐）

```powershell
# 运行自动化测试套件
dotnet run -- --auto

# 查看测试结果
# 所有测试通过会显示：✓ 所有测试通过！
```

### 运行单个测试（调试）

```powershell
# 启动交互式模式
dotnet run

# 按数字选择要运行的测试（1-8）
```

## 📊 测试架构说明

### 代码组织

测试代码采用模块化设计，便于维护和扩展：

```
TestBase.cs                    # 基类（通用功能）
  ├── FindXmlFile()           # 查找测试XML文件
  ├── FindAllXmlFiles()       # 查找所有XML文件
  ├── CreateTestRequest()     # 创建测试请求
  └── ValidateProjectPath()   # 验证项目路径

TestDefinitions.cs             # 测试定义
  ├── TestItem                # 测试项枚举
  ├── TestCategory            # 测试分类枚举
  └── TestInfo                # 测试详细信息

AutomatedTest.cs              # 自动化测试
  └── RunAllTestsAsync()      # 运行所有测试

TestRunner.cs                 # 交互式测试
  └── RunAsync()              # 交互式菜单
```

### 测试分类

| 分类 | 测试项 | 说明 |
|------|--------|------|
| 基础功能 | 测试1-2 | 生成和编译基本功能 |
| 集成测试 | 测试3-5 | 完整流程和多特性集成 |
| 错误处理 | 测试6-7 | 异常情况处理 |
| 在线服务器 | 测试8 | 在线服务器集成 |

## 📝 详细测试说明

### 测试1：从本地XML生成D3项目

**目的**：验证基本的项目生成功能

**测试步骤**：
1. 自动查找 `TemperatureController-v1_0.sila.xml`
2. 调用 `GenerateD3ProjectAsync` 生成项目
3. 验证项目目录结构和必要文件

**预期结果**：
- ✅ 生成临时项目目录
- ✅ 包含所有必需文件（.csproj, .sln, .cs等）
- ✅ 客户端代码已生成并复制
- ✅ 项目路径被记录供后续测试使用

**验证命令**：
```powershell
# 查看生成的项目
$tempPath = [Environment]::GetEnvironmentVariable("TEMP")
Get-ChildItem "$tempPath\Sila2D3Gen" -Directory | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

### 测试2：编译已生成的D3项目

**目的**：验证生成的项目可以成功编译

**前置条件**：需要先运行测试1

**测试步骤**：
1. 使用测试1生成的项目路径
2. 调用 `CompileD3ProjectAsync` 编译项目
3. 验证DLL文件生成

**预期结果**：
- ✅ 编译成功，无错误
- ✅ 生成DLL文件
- ✅ 可能有警告（可接受）
- ✅ 生成XML文档文件

**验证命令**：
```powershell
# 查看编译输出
$projectPath = "<从测试1获取的路径>"
Get-ChildItem "$projectPath\bin" -Recurse -Filter "*.dll"
Get-ChildItem "$projectPath\bin" -Recurse -Filter "*.xml"
```

### 测试3：完整流程（生成+编译）

**目的**：验证完整的生成到编译流程

**测试步骤**：
1. 生成项目（类似测试1）
2. 编译项目（类似测试2）
3. 验证端到端流程

**预期结果**：
- ✅ 生成和编译都成功
- ✅ 无中断错误
- ✅ 生成的代码符合D3规范

### 测试4：调整方法分类并重新生成

**目的**：验证方法分类调整功能

**前置条件**：需要先运行测试1或测试3

**测试步骤**：
1. 创建示例方法分类配置
2. 调用 `AdjustMethodClassificationsAsync` 重新生成
3. 验证D3Driver.cs文件已更新

**预期结果**：
- ✅ 方法分类被正确应用
- ✅ D3Driver.cs包含正确的特性标记
- ✅ 项目可以重新编译

**示例分类**：
```csharp
{
    "TemperatureController.GetTemperature" => false,  // 操作方法
    "TemperatureController.SetTemperature" => false,  // 操作方法
    "TemperatureController.Reset" => true,            // 维护方法
    "TemperatureController.Calibrate" => true         // 维护方法
}
```

### 测试5：多特性完整流程

**目的**：验证多个特性文件的集成生成

**测试步骤**：
1. 自动查找多个.sila.xml文件
2. 使用前2个文件生成项目
3. 编译并验证结果

**预期结果**：
- ✅ 多个特性被正确集成
- ✅ 重复类型被自动去重
- ✅ 所有特性的方法都在D3Driver中
- ✅ 项目可以成功编译

**验证点**：
- 检查 `AllSila2Client.cs` 包含所有特性的方法
- 检查 `D3Driver.cs` 正确调用各特性方法
- 验证重复的DTO类型被注释

### 测试6：错误处理：无效文件

**目的**：验证对不存在文件的错误处理

**测试步骤**：
1. 使用不存在的文件路径
2. 尝试生成项目
3. 验证错误被正确捕获和报告

**预期结果**：
- ✅ 操作失败（预期行为）
- ✅ 返回友好的错误信息
- ✅ 不抛出未处理的异常

### 测试7：错误处理：编译失败

**目的**：验证对编译失败的错误处理

**测试步骤**：
1. 使用不存在的项目路径
2. 尝试编译项目
3. 验证错误被正确捕获和报告

**预期结果**：
- ✅ 操作失败（预期行为）
- ✅ 返回友好的错误信息
- ✅ 不抛出未处理的异常

### 测试8：在线服务器完整流程

**目的**：验证从在线SiLA2服务器生成驱动

**前置条件**（可选）：
- 网络中有运行的SiLA2服务器
- mDNS服务已启用

**测试步骤**：
1. 扫描网络中的SiLA2服务器（3秒超时）
2. 如果找到服务器，生成D3项目
3. 编译并验证结果

**预期结果**：
- 如果有服务器：
  - ✅ 成功扫描到服务器
  - ✅ 获取所有特性信息
  - ✅ 生成并编译项目
- 如果没有服务器：
  - ✅ 测试自动跳过（不算失败）
  - ✅ 显示友好提示信息

**特殊说明**：
- 此测试会复制所有必需的DLL（包括Newtonsoft.Json.dll）
- 支持大量特性的服务器（如23个特性）
- 自动去重重复的类型定义

## 🔍 验证清单

### 生成的文件结构

每次成功生成后，验证以下文件存在：

```
<ProjectPath>/
├── <Namespace>.csproj              # 项目文件
├── <Namespace>.sln                 # 解决方案文件
├── AllSila2Client.cs               # 所有方法的平铺客户端
├── Sila2Base.cs                    # 基类
├── CommunicationPars.cs            # 通信参数
├── D3Driver.cs                     # D3驱动主文件
├── lib/                            # 依赖库
│   ├── BR.ECS.*.dll               # D3相关DLL
│   └── BR.PC.*.dll                # 设备相关DLL
└── GeneratedClient/                # 生成的客户端代码
    ├── I*.cs                       # 接口文件
    ├── *Client.cs                  # 客户端实现
    └── *Dtos.cs                    # 数据传输对象
```

### 代码质量检查

1. **AllSila2Client.cs**
   - ✅ 所有方法签名保持原样（无JSON参数）
   - ✅ XML注释完整（无JSON相关额外注释）
   - ✅ 继承自 Sila2Base

2. **D3Driver.cs**
   - ✅ 只包含被勾选且有特性标记的方法
   - ✅ 不支持的类型参数转换为 `string xxxJsonString`
   - ✅ 不支持的返回类型转换为 `string`
   - ✅ 包含正确的JSON序列化/反序列化代码
   - ✅ 使用友好的类型名（如 `ICollection<Stream>` 而非 `ICollection\`1[[Stream, ...]]`）

3. **项目文件**
   - ✅ 包含 `<GenerateDocumentationFile>true</GenerateDocumentationFile>`
   - ✅ 包含正确的 NuGet 包引用
   - ✅ 项目名称与命名空间一致

### 编译输出检查

```powershell
# 检查DLL文件
$dllPath = "<ProjectPath>\bin\Debug\net8.0\<Namespace>.dll"
Test-Path $dllPath  # 应该返回 True

# 检查XML文档
$xmlPath = "<ProjectPath>\bin\Debug\net8.0\<Namespace>.xml"
Test-Path $xmlPath  # 应该返回 True

# 检查编译警告数
# 应该≤10个警告
```

## 🐛 常见问题排查

### 问题1：找不到XML文件

**症状**：测试1失败，提示"未找到 TemperatureController-v1_0.sila.xml"

**解决方案**：
```powershell
# 确认文件位置
Get-ChildItem -Path "..\.." -Filter "*.sila.xml" -Recurse

# 复制文件到正确位置
Copy-Item "<source>\TemperatureController-v1_0.sila.xml" "..\..\TemperatureController-v1_0.sila.xml"
```

### 问题2：编译失败 - 缺少Newtonsoft.Json

**症状**：编译时提示"找不到类型或命名空间名'Newtonsoft'"

**原因**：`Newtonsoft.Json.dll`未被复制到客户端目录

**解决方案**：
- 此问题已在最新版本中修复
- 确保使用最新的编译版本
- 验证 `ClientCodeGenerator.cs` 包含 `Newtonsoft.Json.dll` 在 `requiredDlls` 列表中

### 问题3：在线服务器测试失败

**症状**：测试8失败

**排查步骤**：
1. 检查网络连接
2. 验证mDNS服务是否启用
3. 确认SiLA2服务器是否运行
4. 查看详细日志输出

### 问题4：多特性测试编译错误

**症状**：测试5编译失败，提示重复类型定义

**原因**：代码去重功能未生效

**验证**：
```powershell
# 检查去重日志
Get-Content test_output.log | Select-String "重复的类型"
```

## 📈 性能基准

### 预期执行时间

| 测试项 | 预期时间 | 备注 |
|--------|---------|------|
| 测试1 | 10-15秒 | 取决于特性数量 |
| 测试2 | 5-10秒 | 取决于代码量 |
| 测试3 | 15-25秒 | 包含生成和编译 |
| 测试4 | 5-10秒 | 增量重新生成 |
| 测试5 | 20-40秒 | 多特性，代码量大 |
| 测试6 | <1秒 | 仅错误处理 |
| 测试7 | <1秒 | 仅错误处理 |
| 测试8 | 30-60秒 | 包含网络扫描和大量特性 |

### 完整测试套件

- **总时间**：约 2-3 分钟
- **测试项数**：8个
- **覆盖率**：>90%核心功能

## ✅ 测试通过标准

### 单个测试通过

- ✓ 显示 "✓ 测试X - 通过"
- ✓ 无错误或异常抛出
- ✓ 生成的文件/输出符合预期

### 完整测试套件通过

```
═══ 自动化测试结果 ═══
✓ 所有测试通过！

验证内容：
  ✓ D3DriverOrchestrationService 无UI依赖
  ✓ 客户端代码生成功能正常
  ✓ 代码分析功能正常
  ✓ D3驱动代码生成功能正常
  ✓ 项目编译功能正常
  ✓ 方法分类调整功能正常
  ✓ 错误处理机制正常
  ✓ 多特性集成正常
```

## 📚 相关文档

- [README.md](./README.md) - 测试控制台概述和快速开始
- [项目文档](../../plan.md) - 完整的项目文档
- [Tecan Generator使用指南](../../Tecan%20Generator生成的客户端使用指南.md) - 客户端代码生成详解

## 🔄 测试维护

### 添加新测试

参考 [README.md#如何添加新测试](./README.md#📖-如何添加新测试)

### 更新测试数据

如果需要使用不同的测试文件：

1. 将新的.sila.xml文件放在项目根目录
2. 更新 `TestBase.FindXmlFile()` 方法中的搜索路径
3. 运行测试验证

### 持续集成

建议在CI/CD管道中集成自动化测试：

```yaml
# 示例 GitHub Actions 配置
- name: Run Tests
  run: |
    cd Sila2DriverGen/TestConsole
    dotnet run -- --auto
```

## 📞 支持

如有问题或需要帮助：
1. 查看本文档的"常见问题排查"部分
2. 查看详细的测试日志
3. 联系 Bioyond Team

---

**最后更新**：2024-10-24  
**版本**：1.0  
**状态**：✅ 所有测试通过
